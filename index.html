<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YouTube Auto Sub</title>
  <meta name="theme-color" content="#0ea5e9" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{
      --ring: #60a5fa;
    }
    body { font-family: 'Inter', sans-serif; }
    .bg-grid {
      background-image: radial-gradient(rgba(2,132,199,.08) 1px, transparent 1px);
      background-size: 18px 18px;
    }
    /* Glass card */
    .glass { background: rgba(255,255,255,.75); backdrop-filter: blur(10px); }
    .shadow-smooth { box-shadow: 0 15px 40px rgba(2,6,23,.12); }
    .ring-focus:focus { outline: none; box-shadow: 0 0 0 4px rgba(59,130,246,.25); }
    @keyframes spinner { to { transform: rotate(360deg); } }
    .spinner { animation: spinner 1.1s linear infinite; }
    /* Toasts */
    .toast-enter{ transform: translateY(8px); opacity: 0; }
    .toast-enter-active{ transform: translateY(0); opacity: 1; transition: all .18s ease; }
    .toast-exit{ transform: translateY(0); opacity: 1; }
    .toast-exit-active{ transform: translateY(-8px); opacity: 0; transition: all .18s ease; }
  </style>
  <!-- Google Identity Services (OAuth) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-50 via-white to-indigo-50 bg-grid">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/60 bg-white/90 border-b border-slate-200">
    <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="help-button" class="w-10 h-10 flex items-center justify-center rounded-full bg-sky-600 text-white hover:bg-sky-700 shadow"> 
          <i class="fa-solid fa-circle-question"></i>
        </button>
        <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-slate-900">YouTube Auto Sub</h1>
      </div>
      <div class="flex items-center gap-2">
        <div id="auth-badge" class="hidden px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">Đã đăng nhập</div>
        <button id="login-button" class="px-4 py-2 rounded-full bg-sky-600 text-white font-semibold hover:bg-sky-700 shadow ring-focus">
          <i class="fab fa-youtube mr-2"></i>Đăng nhập YouTube
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-4xl px-4 py-8">
    <!-- Hero card -->
    <section class="glass shadow-smooth rounded-3xl p-6 sm:p-8">
      <div class="flex flex-col sm:flex-row sm:items-center gap-6">
        <div class="flex-1">
          <h2 class="text-2xl sm:text-3xl font-bold text-slate-900">Nhập kênh từ CSV hoặc quản lý kênh đã theo dõi</h2>
          <p class="mt-2 text-slate-600">Giữ nguyên tính năng cũ, bổ sung chế độ <span class="font-semibold">“Kênh của tôi”</span> để xem và hủy đăng ký. Thiết kế mới nhanh, mượt, tối ưu cho mobile.</p>
        </div>
        <div class="flex items-center gap-2 bg-slate-100 rounded-full p-1">
          <button id="mode-csv" class="px-4 py-2 rounded-full text-sm font-semibold bg-white shadow">CSV</button>
          <button id="mode-mine" class="px-4 py-2 rounded-full text-sm font-semibold text-slate-600">Kênh của tôi</button>
        </div>
      </div>

      <!-- Upload area (CSV mode) -->
      <div id="csv-area" class="mt-6">
        <div id="file-input-area" class="border-2 border-dashed border-sky-300 rounded-xl p-8 text-center cursor-pointer hover:border-sky-500 hover:bg-sky-50">
          <input type="file" id="file-input" class="hidden" accept=".csv" />
          <i class="fa-solid fa-file-csv text-3xl text-sky-500"></i>
          <p class="mt-2 text-slate-700"><span class="text-sky-700 font-semibold">Nhấn để chọn tệp</span> hoặc kéo & thả <span class="font-medium">subscriptions.csv</span></p>
          <p id="file-text" class="text-xs text-slate-500">Chưa chọn tệp</p>
        </div>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="list-channels-button" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700 disabled:opacity-50 disabled:pointer-events-none" disabled>
            <i class="fa-solid fa-list mr-2"></i>Danh sách kênh (tài khoản)
          </button>
          <button id="subscribe-selected-button" class="px-5 py-3 rounded-xl bg-pink-600 text-white font-semibold hover:bg-pink-700 disabled:opacity-50 disabled:pointer-events-none" disabled>
            <i class="fa-solid fa-user-plus mr-2"></i>Đăng ký kênh đã chọn
          </button>
        </div>
      </div>

      <!-- Mine area (list my subscriptions) -->
      <div id="mine-area" class="mt-6 hidden">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-slate-900">Kênh tôi đang theo dõi</h3>
          <button id="refresh-mine" class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 disabled:opacity-50"><i class="fa-solid fa-rotate mr-2"></i>Tải lại</button>
        </div>
      </div>

      <!-- List + progress -->
      <div id="channel-list-container" class="mt-6 hidden">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 select-none">
              <input type="checkbox" id="select-all-checkbox" class="h-5 w-5 text-sky-600 rounded border-slate-300">
              <label for="select-all-checkbox" class="text-sm font-medium text-slate-700">Chọn tất cả</label>
            </div>
            <div id="count-selected" class="text-xs text-slate-500">0 mục đã chọn</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="unsubscribe-button" class="px-4 py-2 rounded-xl bg-rose-600 text-white font-semibold hover:bg-rose-700 disabled:opacity-50" disabled>
              <i class="fa-solid fa-user-minus mr-2"></i>Hủy đăng ký
            </button>
          </div>
        </div>

        <div id="loading-spinner" class="mt-6 hidden text-center">
          <div class="inline-block h-10 w-10 border-4 border-sky-200 border-t-sky-600 rounded-full spinner"></div>
          <p class="mt-3 text-slate-600">Đang tải danh sách kênh...</p>
        </div>

        <div id="channel-list" class="mt-4 space-y-3"></div>

        <div class="mt-6">
          <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full w-0 bg-sky-600"></div>
          </div>
          <div id="progress" class="mt-2 text-sm text-slate-600"></div>
        </div>
      </div>

      <p id="auth-status" class="mt-4 text-sm text-center text-slate-600"></p>
      <p id="error-message" class="mt-3 text-center text-rose-600 font-medium hidden"></p>

      <div class="mt-8 text-center text-sm">
        <a href="https://tinphat.site/privacy.html" class="text-slate-500 hover:text-slate-700 hover:underline">Chính sách bảo mật</a>
      </div>
    </section>
  </main>

  <!-- Help Modal -->
  <div id="help-modal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-x-4 top-10 mx-auto max-w-lg glass shadow-smooth rounded-2xl p-6">
      <div class="flex items-start justify-between">
        <h3 class="text-xl font-bold">Hướng dẫn nhanh</h3>
        <button class="p-2 rounded-full hover:bg-slate-100" data-close><i class="fa-solid fa-xmark"></i></button>
      </div>
      <ol class="mt-4 space-y-4 text-slate-700 text-sm">
        <li><span class="font-semibold">1)</span> Từ tài khoản YouTube cũ, tải <b>subscriptions.csv</b> (Google Takeout).</li>
        <li><span class="font-semibold">2)</span> Bấm <b>Đăng nhập YouTube</b>. Nếu đã cấp trước, hệ thống sẽ tự đăng nhập lại.</li>
        <li><span class="font-semibold">3)</span> Tải CSV lên, chọn kênh rồi bấm <b>Đăng ký kênh đã chọn</b>.</li>
        <li><span class="font-semibold">4)</span> Chuyển sang tab <b>Kênh của tôi</b> để xem/hủy theo dõi.</li>
      </ol>
      <div class="mt-6 text-right">
        <button class="px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700" data-close>Đã hiểu</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="fixed bottom-4 inset-x-4 sm:inset-x-auto sm:right-4 z-[70] space-y-2"></div>

  <script>
    // ======= DOM refs =======
    const loginButton = document.getElementById('login-button');
    const authBadge = document.getElementById('auth-badge');
    const authStatus = document.getElementById('auth-status');
    const errorMessage = document.getElementById('error-message');
    const helpBtn = document.getElementById('help-button');
    const helpModal = document.getElementById('help-modal');
    const toasts = document.getElementById('toasts');

    const modeCSVBtn = document.getElementById('mode-csv');
    const modeMineBtn = document.getElementById('mode-mine');
    const csvArea = document.getElementById('csv-area');
    const mineArea = document.getElementById('mine-area');

    const fileInputArea = document.getElementById('file-input-area');
    const fileInput = document.getElementById('file-input');
    const fileText = document.getElementById('file-text');

    const listChannelsButton = document.getElementById('list-channels-button');
    const subscribeSelectedButton = document.getElementById('subscribe-selected-button');
    const refreshMineBtn = document.getElementById('refresh-mine');

    const channelListContainer = document.getElementById('channel-list-container');
    const channelList = document.getElementById('channel-list');
    const loadingSpinner = document.getElementById('loading-spinner');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const countSelected = document.getElementById('count-selected');
    const unsubscribeButton = document.getElementById('unsubscribe-button');
    const progressText = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');

    // ======= State =======
    let accessToken = null;
    let tokenClient = null;
    let channelsCache = []; // unified: items from CSV (url,title) OR mine (id,title,channelId)
    let mode = 'csv'; // 'csv' | 'mine'

    // ======= Helpers (UI) =======
    function toast(msg, type='info'){
      const id = 't' + Math.random().toString(36).slice(2);
      const el = document.createElement('div');
      const bg = type==='error' ? 'bg-rose-600' : type==='success' ? 'bg-emerald-600' : 'bg-slate-900';
      el.id = id;
      el.className = `toast-enter text-white ${bg} px-4 py-3 rounded-xl shadow-smooth`;
      el.textContent = msg;
      toasts.appendChild(el);
      requestAnimationFrame(()=> el.classList.add('toast-enter-active'));
      setTimeout(()=>{
        el.classList.remove('toast-enter-active');
        el.classList.add('toast-exit-active');
        setTimeout(()=> el.remove(), 200);
      }, 2600);
    }
    function showError(msg){ errorMessage.textContent = msg; errorMessage.classList.remove('hidden'); toast(msg,'error'); }
    function hideError(){ errorMessage.classList.add('hidden'); }
    function setProgress(i, total){
      const pct = total>0 ? Math.round(i*100/total) : 0;
      progressBar.style.width = pct + '%';
    }
    function updateSelectedCount(){
      const n = channelList.querySelectorAll('input[type="checkbox"]:checked').length;
      countSelected.textContent = `${n} mục đã chọn`;
      unsubscribeButton.disabled = n === 0;
      subscribeSelectedButton.disabled = (n === 0) || !accessToken || mode!== 'csv';
    }

    // ======= Modal events =======
    helpBtn.addEventListener('click', ()=> helpModal.classList.remove('hidden'));
    helpModal.addEventListener('click', (e)=>{ if(e.target.dataset.close!==undefined || e.target===helpModal){ helpModal.classList.add('hidden'); }});

    // ======= Mode toggle =======
    function setMode(next){
      mode = next;
      if(next==='csv'){
        modeCSVBtn.classList.add('bg-white','text-slate-900','shadow');
        modeMineBtn.classList.remove('bg-white','text-slate-900','shadow');
        csvArea.classList.remove('hidden');
        mineArea.classList.add('hidden');
      } else {
        modeMineBtn.classList.add('bg-white','text-slate-900','shadow');
        modeCSVBtn.classList.remove('bg-white','text-slate-900','shadow');
        csvArea.classList.add('hidden');
        mineArea.classList.remove('hidden');
        if(accessToken) fetchUserSubscriptions(); else showError('Vui lòng đăng nhập để xem kênh của bạn.');
      }
    }
    modeCSVBtn.addEventListener('click', ()=> setMode('csv'));
    modeMineBtn.addEventListener('click', ()=> setMode('mine'));

    // ======= OAuth (GIS) =======
    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '664290716183-7frfubmiov6gcv811nhsmduqiko21bds.apps.googleusercontent.com', // TODO: thay bằng Client ID của anh
        scope: 'https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/youtube',
        prompt: '',
        callback: (resp) => {
          if(resp && resp.access_token){
            accessToken = resp.access_token;
            authBadge.classList.remove('hidden');
            authStatus.textContent = '';
            loginButton.classList.add('hidden');
            listChannelsButton.disabled = false;
            subscribeSelectedButton.disabled = false;
            toast('Đăng nhập thành công','success');
          } else { authStatus.textContent = 'Không lấy được token. Thử lại.'; }
        }
      });
      // Silent get if previously granted
      try { tokenClient.requestAccessToken({ prompt: 'none' }); } catch(e){}
    };
    function requestToken(){ hideError(); tokenClient.requestAccessToken(); }
    loginButton.addEventListener('click', requestToken);

    // ======= File input (CSV) =======
    fileInputArea.addEventListener('click', ()=> fileInput.click());
    fileInputArea.addEventListener('dragover', (e)=>{ e.preventDefault(); fileInputArea.classList.add('border-sky-500'); });
    fileInputArea.addEventListener('dragleave', (e)=>{ e.preventDefault(); fileInputArea.classList.remove('border-sky-500'); });
    fileInputArea.addEventListener('drop', (e)=>{ e.preventDefault(); fileInputArea.classList.remove('border-sky-500'); const f=e.dataTransfer.files[0]; if(f){ fileText.textContent=f.name; processFile(f);} });
    fileInput.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f){ fileText.textContent=f.name; processFile(f);} });

    // ======= Select all & selection count =======
    selectAllCheckbox.addEventListener('change', (e)=>{
      channelList.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = e.target.checked);
      updateSelectedCount();
    });
    channelList.addEventListener('change', (e)=>{ if(e.target.type==='checkbox') updateSelectedCount(); });

    // ======= Buttons =======
    listChannelsButton.addEventListener('click', ()=>{ if(!accessToken) return showError('Vui lòng đăng nhập YouTube trước.'); fetchUserSubscriptions(); setMode('mine'); });
    refreshMineBtn.addEventListener('click', ()=>{ if(!accessToken) return; fetchUserSubscriptions(); });

    unsubscribeButton.addEventListener('click', onUnsubscribeSelected);
    subscribeSelectedButton.addEventListener('click', onSubscribeSelected);

    // ======= Core CSV =======
    function processFile(file){
      hideError();
      channelListContainer.classList.remove('hidden');
      loadingSpinner.classList.add('hidden');
      channelList.innerHTML='';
      selectAllCheckbox.checked = false;
      progressBar.style.width = '0%';
      progressText.textContent = '';

      const reader = new FileReader();
      reader.onload = (e)=>{
        const text = e.target.result;
        const channels = parseCSV(text); // [{url,title}]
        channelsCache = channels;
        if(channels.length>0){ displayChannels(channels); toast(`Đã nạp ${channels.length} kênh từ CSV`,'success'); }
        else { showError('Không tìm thấy kênh trong CSV. Hãy kiểm tra cột URL và Tên kênh.'); }
      };
      reader.onerror = ()=> showError('Lỗi khi đọc tệp. Vui lòng thử lại.');
      reader.readAsText(file);
    }

    function parseCSV(text){
      const lines = text.split(/\r?\n/);
      if(lines.length<2) return [];
      const headers = lines[0].split(',').map(h=>h.trim().replace(/"/g,''));
      let urlIndex=-1, titleIndex=-1;
      headers.forEach((h,i)=>{
        const lower = h.toLowerCase();
        if(urlIndex===-1 && (lower.includes('url')||lower.includes('link')||lower.includes('address'))) urlIndex=i;
        if(titleIndex===-1 && (lower.includes('title')||lower.includes('name')||lower.includes('kênh'))) titleIndex=i;
      });
      if(urlIndex===-1 || titleIndex===-1) return [];
      const arr=[];
      for(let i=1;i<lines.length;i++){
        const line = lines[i]; if(!line||!line.trim()) continue;
        const parts = splitCSVLine(line);
        if(parts.length>Math.max(urlIndex,titleIndex)){
          const url=(parts[urlIndex]||'').trim().replace(/"/g,'');
          const title=(parts[titleIndex]||'').trim().replace(/"/g,'');
          if(url && title) arr.push({url,title});
        }
      }
      return arr;
    }
    function splitCSVLine(line){
      const out=[]; let inQ=false, cur='';
      for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c==='"') inQ=!inQ;
        else if(c===',' && !inQ){ out.push(cur); cur=''; }
        else cur+=c;
      }
      out.push(cur); return out;
    }

    function displayChannels(items){
      channelList.innerHTML='';
      items.forEach(ch=>{
        const row=document.createElement('div');
        row.className='flex items-center gap-3 p-4 bg-white rounded-xl border border-slate-200 hover:bg-slate-50';
        const cb=document.createElement('input');
        cb.type='checkbox'; cb.className='h-5 w-5 text-sky-600 rounded border-slate-300';
        cb.dataset.payload = JSON.stringify(ch);
        row.appendChild(cb);
        const wrap=document.createElement('div'); wrap.className='flex-1 min-w-0';
        const title=document.createElement('div'); title.className='font-medium text-slate-900 truncate'; title.textContent=ch.title || '(Không tên)';
        const sub=document.createElement('div'); sub.className='text-xs text-slate-500 break-words';
        if(ch.url) sub.textContent=ch.url; else if(ch.channelId) sub.textContent='ID: '+ch.channelId; else sub.textContent='';
        wrap.appendChild(title); wrap.appendChild(sub); row.appendChild(wrap);
        channelList.appendChild(row);
      });
      updateSelectedCount();
    }

    // ======= YouTube API =======
    async function ytGET(url){
      const res = await fetch(url,{ headers:{ 'Authorization': `Bearer ${accessToken}` } });
      if(!res.ok){ const err=await res.json().catch(()=>null); throw new Error(err?.error?.message || `GET ${res.status}`); }
      return res.json();
    }
    async function subscribeChannel(channelId){
      const res = await fetch('https://youtube.googleapis.com/youtube/v3/subscriptions?part=snippet',{
        method:'POST', headers:{ 'Authorization':`Bearer ${accessToken}`, 'Content-Type':'application/json' },
        body: JSON.stringify({ snippet:{ resourceId:{ kind:'youtube#channel', channelId } } })
      });
      if(!res.ok){ const err=await res.json().catch(()=>null); throw new Error(err?.error?.message || `Subscribe ${res.status}`); }
      return true;
    }
    async function unsubscribeChannel(subscriptionId){
      const res = await fetch(`https://youtube.googleapis.com/youtube/v3/subscriptions?id=${subscriptionId}`,{
        method:'DELETE', headers:{ 'Authorization':`Bearer ${accessToken}` }
      });
      if(!res.ok){ const err=await res.json().catch(()=>null); throw new Error(err?.error?.message || `Unsubscribe ${res.status}`); }
      return true;
    }

    // Resolve helpers
    function extractUC(raw){ try{ const u=new URL(raw); const m=u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{21,})/); return m?m[1]:null; }catch{ return null; } }
    function extractHandle(raw){ try{ const u=new URL(raw); const m=u.pathname.match(/^\/@([A-Za-z0-9._-]+)/); return m?'@'+m[1]:null; }catch{ return null; } }
    function extractUserName(raw){ try{ const u=new URL(raw); const m=u.pathname.match(/^\/user\/([A-Za-z0-9._-]+)/); return m?m[1]:null; }catch{ return null; } }

    async function resolveChannelId(url, titleFallback=''){
      const direct = extractUC(url); if(direct) return direct;
      const handle = extractHandle(url); if(handle){ const d=await ytGET(`https://youtube.googleapis.com/youtube/v3/channels?part=id&forHandle=${encodeURIComponent(handle)}`); return d?.items?.[0]?.id||null; }
      const user = extractUserName(url); if(user){ const d=await ytGET(`https://youtube.googleapis.com/youtube/v3/channels?part=id&forUsername=${encodeURIComponent(user)}`); if(d?.items?.[0]?.id) return d.items[0].id; }
      if(titleFallback){ const d=await ytGET(`https://youtube.googleapis.com/youtube/v3/search?part=snippet&type=channel&maxResults=1&q=${encodeURIComponent(titleFallback)}`); return d?.items?.[0]?.snippet?.channelId||null; }
      return null;
    }

    // List my subscriptions
    async function listUserSubscriptions(){
      let all=[]; let page='';
      do{
        const url=`https://youtube.googleapis.com/youtube/v3/subscriptions?part=snippet&maxResults=50&mine=true${page?`&pageToken=${page}`:''}`;
        const res = await fetch(url,{ headers:{ 'Authorization':`Bearer ${accessToken}` } });
        if(!res.ok){ const err=await res.json().catch(()=>null); throw new Error(err?.error?.message || `GET ${res.status}`); }
        const data = await res.json();
        all = all.concat(data.items);
        page = data.nextPageToken;
      } while(page);
      return all;
    }

    async function fetchUserSubscriptions(){
      hideError();
      channelListContainer.classList.remove('hidden');
      loadingSpinner.classList.remove('hidden');
      channelList.innerHTML='';
      selectAllCheckbox.checked=false; updateSelectedCount();
      progressBar.style.width='0%'; progressText.textContent='';
      try{
        const subs = await listUserSubscriptions();
        channelsCache = subs.map(s=>({ id:s.id, title:s.snippet.title, channelId:s.snippet.resourceId.channelId }));
        loadingSpinner.classList.add('hidden');
        if(channelsCache.length){ displayChannels(channelsCache); toast(`Đã tải ${channelsCache.length} kênh đang theo dõi`,'success'); }
        else { showError('Tài khoản này không đăng ký kênh nào.'); }
      }catch(err){ loadingSpinner.classList.add('hidden'); showError('Lỗi khi tải danh sách kênh. Vui lòng thử lại.'); console.error(err); }
    }

    // ======= Actions =======
    async function onSubscribeSelected(){
      hideError(); if(!accessToken) return showError('Vui lòng đăng nhập YouTube trước.');
      const checks=[...channelList.querySelectorAll('input[type="checkbox"]:checked')];
      if(checks.length===0) return showError('Chọn ít nhất một kênh để đăng ký.');
      subscribeSelectedButton.disabled=true;
      let ok=0, fail=0;
      for(let i=0;i<checks.length;i++){
        const { url, title } = JSON.parse(checks[i].dataset.payload);
        progressText.textContent = `(${i+1}/${checks.length}) Đang xử lý: ${title}...`;
        setProgress(i, checks.length);
        try{
          const channelId = await resolveChannelId(url, title);
          if(!channelId) throw new Error('Không tìm được channelId');
          await subscribeChannel(channelId); ok++;
        }catch(e){ console.error('Subscribe failed', title, e); fail++; }
      }
      setProgress(checks.length, checks.length);
      progressText.textContent = `Hoàn tất: ${ok} thành công, ${fail} thất bại.`;
      toast(`Đăng ký xong: ${ok}/${checks.length}`,(fail? 'error':'success'));
      subscribeSelectedButton.disabled=false;
    }

    async function onUnsubscribeSelected(){
      hideError(); if(!accessToken) return showError('Vui lòng đăng nhập YouTube trước.');
      const checks=[...channelList.querySelectorAll('input[type="checkbox"]:checked')];
      if(checks.length===0) return showError('Chọn ít nhất một kênh để hủy.');
      unsubscribeButton.disabled=true;
      let ok=0, fail=0;
      for(let i=0;i<checks.length;i++){
        const { id, title } = JSON.parse(checks[i].dataset.payload);
        progressText.textContent = `(${i+1}/${checks.length}) Hủy đăng ký: ${title}...`;
        setProgress(i, checks.length);
        try{ await unsubscribeChannel(id); ok++; }
        catch(e){ console.error('Unsub failed', title, e); fail++; }
      }
      setProgress(checks.length, checks.length);
      progressText.textContent = `Hoàn tất: ${ok} thành công, ${fail} thất bại.`;
      toast(`Hủy đăng ký xong: ${ok}/${checks.length}`,(fail? 'error':'success'));
      unsubscribeButton.disabled=false;
      fetchUserSubscriptions();
    }
  </script>
</body>
</html>
