<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YouTube Auto Sub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #eef2ff, #c3dafe);
      background-attachment: fixed;
      overflow-x: hidden;
    }
    .custom-shadow {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    /* Simple animation for the modal */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    #help-modal .modal-content, #welcome-modal .modal-content {
      animation: fadeIn 0.3s cubic-bezier(0.2, 0, 0, 1);
    }
    /* Preloader animation */
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; visibility: hidden; }
    }
    #preloader {
      animation: fadeOut 0.5s ease-out 1.5s forwards;
    }
    .loader {
      border-top-color: #3498db;
      -webkit-animation: spinner 1.5s linear infinite;
      animation: spinner 1.5s linear infinite;
    }
    @-webkit-keyframes spinner {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <!-- Google Identity Services (OAuth) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-8 relative">

  <!-- Preloader -->
  <div id="preloader" class="fixed inset-0 bg-blue-50 bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[9999]">
    <div class="loader ease-linear rounded-full border-8 border-t-8 border-blue-200 h-24 w-24"></div>
  </div>

  <!-- Welcome Modal -->
  <div id="welcome-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden backdrop-blur-sm">
    <div class="modal-content bg-white rounded-3xl w-full max-w-sm sm:max-w-md p-6 sm:p-8 relative custom-shadow flex flex-col items-center text-center">
      <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4">Chào mừng bạn!</h2>
      <div class="text-center mb-6">
        <img id="welcome-image" src="https://placehold.co/400x200/eef2ff/4338ca?text=Welcome" alt="Welcome Image" class="rounded-lg shadow-md mb-4">
        <p class="text-gray-700">Xem hướng dẫn ở icon góc trái nhé. Muốn mua <b>Youtube Premium</b> giá ưu đãi liên hệ admin <a href="https://www.zalo.me/nguyentinphat" class="text-blue-600 hover:underline font-semibold" >tại đây.</a></p>
      </div>
      <div class="mt-auto">
        <button id="close-welcome-modal" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 transition transform hover:scale-105">Bắt đầu ngay</button>
      </div>
    </div>
  </div>
  
  <!-- Help Button -->
  <button id="help-button" class="fixed top-4 left-4 sm:top-8 sm:left-8 w-12 h-12 flex items-center justify-center rounded-full bg-blue-600 text-white shadow-lg z-40 transition-all duration-300 hover:scale-110 hover:bg-blue-700">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
      <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.852l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
    </svg>
  </button>

  <!-- Help Modal -->
  <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden backdrop-blur-sm">
    <div class="modal-content bg-white rounded-3xl w-full max-w-xs sm:max-w-md p-4 sm:p-6 relative custom-shadow">
      
      <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-900 mb-6 sm:mb-8">Hướng dẫn sử dụng</h2>
      
      <ol class="space-y-4 sm:space-y-6 text-sm sm:text-base text-gray-700">
        <!-- Step 1 -->
        <li class="flex items-start space-x-4">
          <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-600 rounded-full font-bold">1</div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-gray-800">Lấy tệp subscriptions.csv</h3>
            <p class="mt-1">Truy cập tài khoản YouTube cũ của bạn và tải xuống tệp chứa danh sách các kênh đã đăng ký. <a href="https://voz.ee/s/eEynG5kll" class="text-blue-600 hover:underline font-semibold" id="get-file-link">Lấy tệp CSV tại đây.</a></p>
          </div>
        </li>
        <!-- Step 2 -->
        <li class="flex items-start space-x-4">
          <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 bg-emerald-100 text-emerald-600 rounded-full font-bold">2</div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-gray-800">Đăng nhập tài khoản YouTube mới</h3>
            <p class="mt-1">Nhấn nút <b>Đăng nhập YouTube</b> trên website để kết nối. Nếu gặp cảnh báo, vui lòng làm theo hướng dẫn <a href="https://voz.ee/s/9sGsujpt1" class="text-blue-600 hover:underline font-semibold" id="handle-warning-link">tại đây.</a></p>
          </div>
        </li>
        <!-- Step 3 -->
        <li class="flex items-start space-x-4">
          <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 bg-pink-100 text-pink-600 rounded-full font-bold">3</div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-gray-800">Tải lên tệp và bắt đầu</h3>
            <p class="mt-1">Tải tệp CSV đã lấy lên website, sau đó nhấn <b>Chọn tất cả</b> rồi <b>Đăng ký kênh</b>. Công cụ sẽ tự động chạy.</p>
            <p class="mt-1 italic text-xs text-gray-500">Ghi chú: Bạn có thể bỏ chọn các kênh không muốn đăng ký.</p>
          </div>
        </li>
      </ol>
      <div class="mt-8 text-center">
          <button id="close-modal-button" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-full shadow-md hover:bg-gray-300 transition transform hover:scale-105">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-xl w-full mx-auto bg-white rounded-3xl p-6 sm:p-10 custom-shadow transform transition-transform duration-300 hover:scale-[1.01]">
    
    <!-- Header Section -->
    <header class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-1 tracking-tight">
        YouTube Auto Sub
      </h1>
      <p class="text-base sm:text-lg text-gray-500">Tải lên tệp <strong>subscriptions.csv</strong> từ Google Takeout.</p>
    </header>

    <!-- File Upload Area -->
    <div id="file-input-area" class="border-2 border-dashed border-blue-300 rounded-xl p-8 sm:p-12 text-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:bg-blue-50">
      <input type="file" id="file-input" class="hidden" accept=".csv" />
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-blue-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8"></path>
      </svg>
      <p id="file-text" class="text-gray-600 font-medium">
        <span class="text-blue-600 font-bold">Nhấn để chọn tệp</span> hoặc kéo & thả
      </p>
    </div>

    <!-- Action Buttons -->
    <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
      <button id="login-button" class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 transition transform hover:scale-105">Đăng nhập YouTube</button>
      <button id="open-selected-button" class="px-5 py-3 bg-emerald-600 text-white font-semibold rounded-full shadow-md hover:bg-emerald-700 transition transform hover:scale-105">Mở Kênh Đã Chọn</button>
      <button id="subscribe-selected-button" class="px-5 py-3 bg-pink-600 text-white font-semibold rounded-full shadow-md hover:bg-pink-700 transition transform hover:scale-105 disabled:opacity-50 disabled:pointer-events-none" disabled>Đăng ký kênh</button>
    </div>

    <!-- Status & Error Messages -->
    <div id="auth-status" class="mt-4 text-center text-sm text-gray-600 font-medium"></div>
    <div id="error-message" class="text-center text-red-500 mt-4 font-medium hidden"></div>

    <!-- Channel List & Progress -->
    <div id="channel-list-container" class="mt-8 hidden">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 space-y-2 sm:space-y-0">
        <h2 class="text-2xl font-bold text-gray-800">Danh sách Kênh</h2>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="select-all-checkbox" class="text-sm font-medium text-gray-700 select-none cursor-pointer">Chọn tất cả</label>
        </div>
      </div>
      <div id="loading-spinner" class="text-center hidden">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-2 text-gray-600">Đang tải danh sách kênh...</p>
      </div>
      <div id="channel-list" class="space-y-3"></div>
      <div id="progress" class="mt-4 text-sm text-gray-600"></div>
    </div>

    <!-- Privacy Policy Link -->
    <div class="mt-10 text-center">
        <a href="https://tinphat.site/privacy.html" class="text-sm text-gray-500 hover:text-gray-700 hover:underline transition">Chính sách bảo mật</a>
    </div>

  </div>

  <script>
    // ========= DOM refs =========
    const fileInput = document.getElementById('file-input');
    const fileInputArea = document.getElementById('file-input-area');
    const fileText = document.getElementById('file-text');
    const channelListContainer = document.getElementById('channel-list-container');
    const channelList = document.getElementById('channel-list');
    const loadingSpinner = document.getElementById('loading-spinner');
    const errorMessage = document.getElementById('error-message');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const openSelectedButton = document.getElementById('open-selected-button');
    const subscribeSelectedButton = document.getElementById('subscribe-selected-button');
    const loginButton = document.getElementById('login-button');
    const authStatus = document.getElementById('auth-status');
    const progress = document.getElementById('progress');
    const helpButton = document.getElementById('help-button');
    const helpModal = document.getElementById('help-modal');
    const closeModalButton = document.getElementById('close-modal-button');
    const getFileLink = document.getElementById('get-file-link');
    const handleWarningLink = document.getElementById('handle-warning-link');
    const welcomeModal = document.getElementById('welcome-modal');
    const closeWelcomeModalButton = document.getElementById('close-welcome-modal');


    // Add event listeners for the welcome modal
    closeWelcomeModalButton.addEventListener('click', () => {
      welcomeModal.classList.add('hidden');
    });

    // Add event listeners for the help modal
    helpButton.addEventListener('click', () => {
      helpModal.classList.remove('hidden');
    });

    closeModalButton.addEventListener('click', () => {
      helpModal.classList.add('hidden');
    });

    // You can replace '#' with actual URLs here
    getFileLink.addEventListener('click', (e) => {
        e.preventDefault();
        window.open('https://voz.ee/s/eEynG5kll', '_blank');
    });

    handleWarningLink.addEventListener('click', (e) => {
        e.preventDefault();
        // Here you would add the link to your specific warning guide
        window.open('https://voz.ee/s/9sGsujpt1', '_blank');
    });

    // ========= State =========
    let accessToken = null;
    let tokenClient = null;
    let channelsCache = []; // {url, title}

    // ========= OAuth (GIS) =========
    window.onload = () => {
      // Hide preloader and show welcome modal after a delay
      const preloader = document.getElementById('preloader');
      setTimeout(() => {
          preloader.style.display = 'none';
          welcomeModal.classList.remove('hidden');
      }, 2000); // Wait for 2 seconds before fading out preloader

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '664290716183-7frfubmiov6gcv811nhsmduqiko21bds.apps.googleusercontent.com', // TODO: thay bằng Client ID của anh
        scope: 'https://www.googleapis.com/auth/youtube',
        prompt: '', // lần đầu vẫn hiện consent
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            authStatus.innerHTML = '<span class="px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-full animate-pulse">Đã đăng nhập thành công!</span>';
            subscribeSelectedButton.disabled = false;
          } else {
            authStatus.textContent = 'Không lấy được token. Thử lại.';
          }
        }
      });
    };

    function requestToken() {
      tokenClient.requestAccessToken();
    }

    loginButton.addEventListener('click', () => requestToken());

    // ========= File input events =========
    fileInputArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) { fileText.textContent = file.name; processFile(file); }
    });
    fileInputArea.addEventListener('dragover', (e) => { e.preventDefault(); fileInputArea.classList.add('border-blue-500'); });
    fileInputArea.addEventListener('dragleave', (e) => { e.preventDefault(); fileInputArea.classList.remove('border-blue-500'); });
    fileInputArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileInputArea.classList.remove('border-blue-500');
      const file = e.dataTransfer.files[0];
      if (file) { fileText.textContent = file.name; processFile(file); }
    });

    // ========= Select all =========
    selectAllCheckbox.addEventListener('change', (event) => {
      const checkboxes = document.querySelectorAll('#channel-list input[type="checkbox"]');
      checkboxes.forEach(checkbox => checkbox.checked = event.target.checked);
    });

    // ========= Open selected (UI route) =========
    openSelectedButton.addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('#channel-list input[type="checkbox"]:checked');
      if (checkboxes.length === 0) return showError('Vui lòng chọn ít nhất một kênh để mở.');
      checkboxes.forEach(checkbox => {
        const raw = checkbox.dataset.url;
        if (raw) {
          const u = buildSubscribeUrl(raw);
          window.open(u, '_blank', 'noopener');
        }
      });
    });

    // ========= Subscribe selected (API route) =========
    subscribeSelectedButton.addEventListener('click', async () => {
      errorMessage.classList.add('hidden');
      progress.textContent = '';
      if (!accessToken) return showError('Vui lòng bấm “Đăng nhập YouTube” trước.');

      const checks = Array.from(document.querySelectorAll('#channel-list input[type="checkbox"]:checked'));
      if (checks.length === 0) return showError('Vui lòng chọn ít nhất một kênh để đăng ký.');

      // Tạo hàng tác vụ tuần tự để dễ kiểm soát quota + thông báo
      let okCount = 0, failCount = 0;
      for (let i = 0; i < checks.length; i++) {
        const { url, title } = JSON.parse(checks[i].dataset.payload);
        progress.textContent = `(${i+1}/${checks.length}) Đang xử lý: ${title}...`;
        try {
          const channelId = await resolveChannelId(url, title);
          if (!channelId) throw new Error('Không tìm được channelId');
          await subscribeChannel(channelId);
          okCount++;
        } catch (err) {
          console.error('Subscribe failed for', title, err);
          failCount++;
        }
      }
      progress.textContent = `Hoàn tất: ${okCount} thành công, ${failCount} thất bại.`;
      if (failCount > 0) showError('Một số kênh đăng ký thất bại. Xem console để biết chi tiết.');
    });

    // ========= Core functions =========
    function processFile(file) {
      errorMessage.classList.add('hidden');
      channelListContainer.classList.add('hidden');
      loadingSpinner.classList.remove('hidden');
      channelList.innerHTML = '';
      selectAllCheckbox.checked = false;

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const channels = parseCSV(text); // [{url,title}]
        channelsCache = channels;
        if (channels.length > 0) {
          loadingSpinner.classList.add('hidden');
          channelListContainer.classList.remove('hidden');
          displayChannels(channels);
        } else {
          loadingSpinner.classList.add('hidden');
          showError('Không tìm thấy kênh trong CSV. Hãy kiểm tra cột URL và Tên kênh.');
        }
      };
      reader.onerror = () => {
        loadingSpinner.classList.add('hidden');
        showError('Lỗi khi đọc tệp. Vui lòng thử lại.');
      };
      reader.readAsText(file);
    }

    function parseCSV(text) {
      const lines = text.split('\n');
      if (lines.length < 2) return [];
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

      // Tự dò cột URL / Title (giống file gốc) 
      let urlIndex = -1, titleIndex = -1;
      headers.forEach((h, i) => {
        const lower = h.toLowerCase();
        if (urlIndex === -1 && (lower.includes('url') || lower.includes('link') || lower.includes('address'))) urlIndex = i;
        if (titleIndex === -1 && (lower.includes('title') || lower.includes('name') || lower.includes('kênh'))) titleIndex = i;
      });

      if (urlIndex === -1 || titleIndex === -1) return [];

      const arr = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line || !line.trim()) continue;
        const parts = splitCSVLine(line);
        if (parts.length > Math.max(urlIndex, titleIndex)) {
          const url = (parts[urlIndex] || '').trim().replace(/"/g, '');
          const title = (parts[titleIndex] || '').trim().replace(/"/g, '');
          if (url && title) arr.push({ url, title });
        }
      }
      return arr;
    }

    function splitCSVLine(line) {
      const parts = [];
      let inQuote = false, cur = '';
      for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"') inQuote = !inQuote;
        else if (c === ',' && !inQuote) { parts.push(cur); cur = ''; }
        else cur += c;
      }
      parts.push(cur);
      return parts;
    }

    function displayChannels(channels) {
      channelList.innerHTML = '';
      channels.forEach(ch => {
        const row = document.createElement('div');
        row.className = 'flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm transition-all duration-200 hover:bg-gray-100';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'mr-3 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded';
        checkbox.dataset.url = ch.url;
        checkbox.dataset.payload = JSON.stringify(ch);
        row.appendChild(checkbox);

        const wrap = document.createElement('div');
        wrap.className = 'flex flex-col flex-1 min-w-0';

        const t = document.createElement('div');
        t.className = 'text-gray-800 font-medium truncate';
        t.textContent = ch.title;

        const u = document.createElement('a');
        u.className = 'text-xs text-blue-600 hover:underline break-words';
        u.href = ch.url; u.target = '_blank'; u.rel = 'noopener';
        u.textContent = ch.url;

        wrap.appendChild(t);
        wrap.appendChild(u);
        row.appendChild(wrap);
        channelList.appendChild(row);
      });
    }

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.classList.remove('hidden');
    }

    // Build URL mở tab với popup confirm (nếu phù hợp)
    function buildSubscribeUrl(raw) {
      try {
        const u = new URL(raw);
        if (u.hostname === 'm.youtube.com' || u.hostname === 'youtube.com') u.hostname = 'www.youtube.com';
        if (!u.searchParams.has('sub_confirmation')) u.searchParams.set('sub_confirmation', '1');
        u.searchParams.set('app', 'desktop');
        u.searchParams.set('persist_app', '1');
        return u.toString();
      } catch {
        const sep = raw.includes('?') ? '&' : '?';
        return `${raw}${sep}sub_confirmation=1&app=desktop&persist_app=1`;
      }
    }

    // ========= YouTube API helpers =========
    async function resolveChannelId(url, titleFallback='') {
      // 1) Nếu là /channel/UC.... => lấy luôn
      const extracted = extractUC(url);
      if (extracted) return extracted;

      // 2) Nếu là /@handle => dùng channels.list?forHandle=@...
      const handle = extractHandle(url);
      if (handle) {
        const data = await ytGET(`https://youtube.googleapis.com/youtube/v3/channels?part=id&forHandle=${encodeURIComponent(handle)}`);
        return data?.items?.[0]?.id || null;
      }

      // 3) /user/username => thử forUsername (vẫn hoạt động cho một số kênh cũ)
      const username = extractUserName(url);
      if (username) {
        const data = await ytGET(`https://youtube.googleapis.com/youtube/v3/channels?part=id&forUsername=${encodeURIComponent(username)}`);
        if (data?.items?.[0]?.id) return data.items[0].id;
      }

      // 4) /c/custom-name hoặc không rõ → fallback: search theo title (type=channel)
      if (titleFallback) {
        const data = await ytGET(`https://youtube.googleapis.com/youtube/v3/search?part=snippet&type=channel&maxResults=1&q=${encodeURIComponent(titleFallback)}`);
        return data?.items?.[0]?.snippet?.channelId || null;
      }

      return null;
    }

    function extractUC(raw) {
      try {
        const u = new URL(raw);
        const m = u.pathname.match(/\/channel\/(UC[0-9A-Za-z_-]{21,})/);
        return m ? m[1] : null;
      } catch { return null; }
    }

    function extractHandle(raw) {
      try {
        const u = new URL(raw);
        const m = u.pathname.match(/^\/@([A-Za-z0-9._-]+)/);
        return m ? '@' + m[1] : null;
      } catch { return null; }
    }

    function extractUserName(raw) {
      try {
        const u = new URL(raw);
        const m = u.pathname.match(/^\/user\/([A-Za-z0-9._-]+)/);
        return m ? m[1] : null;
      } catch { return null; }
    }

    async function ytGET(url) {
      const res = await fetch(url, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      if (!res.ok) throw new Error(`YouTube GET failed ${res.status}`);
      return res.json();
    }

    async function subscribeChannel(channelId) {
      const res = await fetch('https://youtube.googleapis.com/youtube/v3/subscriptions?part=snippet', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          snippet: {
            resourceId: { kind: 'youtube#channel', channelId }
          }
        })
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>null);
        throw new Error(err?.error?.message || `Subscribe failed ${res.status}`);
      }
      return true;
    }
  </script>
</body>
</html>
